import{Z as e,a0 as t,a1 as n,$ as s,R as r,a2 as o,a3 as a,a4 as i,a5 as c,a6 as u,f as l,a7 as d,a8 as p,a9 as f,U as m,T as v,B as w,aa as g,ab as h}from"./datadog-BkLmkJ5p.js";import"./permissions-BsMI2TUG.js";import"./Main-DIS361Sg.js";function b(e,t){return new Promise(n=>{e.write(t),e.finish(e=>{n(e)})})}const k=new Map;function y(e){return k.get(e)}function T(e){for(const t of k.keys())t<e&&k.delete(t)}function I({rawRumEvent:e,startTime:t}){if(e.type!==r.LONG_TASK)return;!function(e,t){k.set(t,e)}(e.long_task.id,t)}const M=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;const S=(e,t)=>e||function(e){return e?e.replace(M,"/?"):"/"}(t);function E(e,t,n){const s={application:{id:t}};n&&(s.session={id:n});const{ids:r,names:o}=function(e){const t={ids:[],names:[]};for(const n of e)t.ids.push(n.viewId),n.viewName&&t.names.push(n.viewName);return t.names=Array.from(new Set(t.names)),t}(e.views);r.length&&(s.view={id:r,name:o});const a=e.longTasks.map(e=>e.id).filter(e=>void 0!==e);return a.length&&(s.long_task={id:a}),s}function _(e,t,n){const s=function(e,t,n){const s=o(t),r=E(e,t.applicationId,n),i=function(e){const t=e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"]);return t}(s),c={...r,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:i.join(","),_dd:{clock_drift:a()}};return c}(e,t,n);return{event:s,"wall-time.json":e}}const C={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function j(r,o,a,k,M,E=C){const j=function(r,o,a,i){const c=e([r.profilingEndpointBuilder],r.batchBytesLimit,e=>{o.notify(14,{error:e}),s("Error reported to customer",{"error.message":e.message})}),u=a(i);return{async send({event:e,...s}){const r=new FormData,o=t(e);if(!o)throw new Error("Failed to serialize event");r.append("event",new Blob([o],{type:"application/json"}),"event.json");let a=o.length;for(const[i,c]of n(s)){const e=t(c);if(!e)throw new Error("Failed to serialize attachment");const n=await b(u,e);a+=n.outputBytesCount,r.append(i,new Blob([n.output]),i)}c.send({data:r,bytesCount:a})}}}(r,o,M,6),N=i(c.LONG_ANIMATION_FRAME);let O;const P=[];let D={state:"stopped"};function B(){const e=d().Profiler;if(!e)throw k.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");L(D).catch(p);const{cleanupTasks:t,observer:n}=function(e){if("running"===e.state)return{cleanupTasks:e.cleanupTasks,observer:e.observer};const t=[];let n;if(r.trackLongTasks){n=new PerformanceObserver(F),n.observe({entryTypes:[N?"long-animation-frame":"longtask"]});const e=o.subscribe(12,e=>{I(e)});t.push(()=>null==n?void 0:n.disconnect()),t.push(e.unsubscribe)}const s=o.subscribe(2,e=>{const t={viewId:e.id,viewName:S(e.name,document.location.pathname),startClocks:e.startClocks};A(t),O=t});return t.push(s.unsubscribe),{cleanupTasks:t,observer:n}}(D);let s;try{s=new e({sampleInterval:E.sampleIntervalMs,maxBufferSize:Math.round(1.5*E.collectIntervalMs/E.sampleIntervalMs)})}catch(a){return void(a instanceof Error&&a.message.includes("disabled by Document Policy")?(f.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",a),k.set({status:"error",error_reason:"missing-document-policy-header"})):k.set({status:"error",error_reason:"unexpected-exception"}))}k.set({status:"running",error_reason:void 0}),D={state:"running",startClocks:u(),profiler:s,timeoutId:m(B,E.collectIntervalMs),longTasks:[],views:[],cleanupTasks:t,observer:n},A(O),s.addEventListener("samplebufferfull",x)}async function L(e){var t,n;if("running"!==e.state)return;z(null!==(n=null===(t=e.observer)||void 0===t?void 0:t.takeRecords())&&void 0!==n?n:[]),v(e.timeoutId),e.profiler.removeEventListener("samplebufferfull",x);const{startClocks:s,longTasks:o,views:i}=e,c=u();await e.profiler.stop().then(e=>{const t=u(),n=o.length>0,l=w(s.timeStamp,t.timeStamp)<E.minProfileDurationMs,d=function(e){let t=0;for(const n of e)void 0!==n.stackId&&t++;return t}(e.samples)<E.minNumberOfSamples;(n||!l&&!d)&&(!function(e){var t;const n=null===(t=a.findTrackedSession())||void 0===t?void 0:t.id,s=_(e,r,n);j.send(s)}(Object.assign(e,{startClocks:s,endClocks:t,clocksOrigin:g(),longTasks:o,views:i,sampleInterval:E.sampleIntervalMs})),T(c.relative))}).catch(p)}async function R(e){"running"===D.state&&(D.cleanupTasks.forEach(e=>e()),await L(D),D={state:e})}function A(e){"running"===D.state&&e&&D.views.push(e)}function x(){B()}function F(e){z(e.getEntries())}function z(e){if("running"===D.state)for(const t of e){if(t.duration<E.sampleIntervalMs)continue;const e=h(t.startTime),n=y(e.relative);D.longTasks.push({id:n,duration:t.duration,entryType:t.entryType,startClocks:e})}}function U(){"hidden"===document.visibilityState&&"running"===D.state?R("paused").catch(p):"visible"===document.visibilityState&&"paused"===D.state&&B()}function G(){B()}return{start:function(e){"running"!==D.state&&(O=e?{startClocks:e.startClocks,viewId:e.id,viewName:S(e.name,document.location.pathname)}:void 0,P.push(l(r,window,"visibilitychange",U).stop,l(r,window,"beforeunload",G).stop),B())},stop:async function(){await R("stopped"),P.forEach(e=>e()),T(u().relative),k.set({status:"stopped",error_reason:void 0})},isStopped:function(){return"stopped"===D.state},isRunning:function(){return"running"===D.state},isPaused:function(){return"paused"===D.state}}}export{C as DEFAULT_RUM_PROFILER_CONFIGURATION,j as createRumProfiler};
