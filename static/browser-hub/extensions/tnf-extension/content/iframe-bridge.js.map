{"version":3,"file":"content/iframe-bridge.js","mappings":";;AAAA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,MAAM;AACzB,gDAAgD,YAAY;AAC5D,yDAAyD,UAAU;AACnE;AACA,OAAO;AACP;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uDAAuD,YAAY;AACnE;AACA;AACA,4BAA4B,MAAM;AAClC;AACA,4BAA4B,iBAAiB;AAC7C;AACA,WAAW;AACX;AACA;AACA,KAAK;AACL,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAsB,MAAM;AAC5B,kDAAkD,QAAQ;AAC1D,0BAA0B,UAAU;AACpC;AACA,SAAS;AACT;AACA,KAAK;AACL;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,mCAAmC,cAAc;;AAEjD;AACA;AACA;AACA,2CAA2C,cAAc;AACzD;AACA,OAAO;AACP;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAkB;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;AACA,WAAW,6BAA6B;AACxC,SAAS,0BAA0B;AACnC;AACA;AACA,WAAW,0BAA0B;AACrC,SAAS,6BAA6B;AACtC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAG;AACH;AACA,GAAG;;AAEH;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,YAAY,4CAA4C;;AAExD;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,4CAA4C,yBAAyB;AACrE,WAAW;AACX;AACA;;AAEA;AACA;AACA;AACA,oDAAoD,yBAAyB;AAC7E;AACA,SAAS;;AAET;AACA;AACA;AACA,mCAAmC,yBAAyB;AAC5D,SAAS;AACT;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;;AAEL;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,CAAC;;AAED;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA,mBAAmB,gBAAgB;AACnC;AACA;;AAEA;AACA,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAG;AACH;AACA;;AAEA","sources":["webpack://the-new-fuse-chrome-extension/./src/v6/content/ai-studio/iframe-bridge.js"],"sourcesContent":["// Content script for bridging communication between custom AI Studio apps (in usercontent.goog iframes)\n// and the Chrome Extension\nconsole.log('[AI Video Suite] Iframe Bridge: Content script loaded in iframe');\n\n// Detect if we're in the custom \"The New Fuse - AI Library\" app\nconst isCustomApp = () => {\n  return (\n    window.location.hostname.endsWith('.usercontent.goog') ||\n    document.title.includes('The New Fuse') ||\n    document.title.includes('AI Library') ||\n    document.querySelector('[data-app-name*=\"fuse\"]') !== null\n  );\n};\n\n// Extract queue data directly from the DOM\n// This bypasses the app's extension check which relies on a flag we can't set due to CSP\nconst extractQueueFromDOM = () => {\n  console.log('[AI Video Suite] Extracting queue from DOM...');\n\n  const queue = [];\n\n  // Try to find queue table rows\n  const tableRows = document.querySelectorAll(\n    'table tbody tr, [class*=\"queue\"] tr, [class*=\"video\"] tr'\n  );\n  tableRows.forEach((row, index) => {\n    const cells = row.querySelectorAll('td');\n    // Look for YouTube URL in the row\n    const rowText = row.textContent || '';\n    const urlMatch = rowText.match(/(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]+)/);\n    if (urlMatch) {\n      queue.push({\n        id: `dom-${index}`,\n        url: `https://www.youtube.com/watch?v=${urlMatch[1]}`,\n        title: cells[0]?.textContent?.trim() || `Video ${index + 1}`,\n        status: 'pending',\n      });\n    }\n  });\n\n  // Also try textarea with bulk import URLs\n  const textareas = document.querySelectorAll('textarea');\n  textareas.forEach((textarea) => {\n    const text = textarea.value || '';\n    const lines = text.split('\\n').filter((line) => line.trim());\n    lines.forEach((line, index) => {\n      const urlMatch = line.match(/(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]+)/);\n      if (urlMatch) {\n        // Avoid duplicates\n        const url = `https://www.youtube.com/watch?v=${urlMatch[1]}`;\n        if (!queue.some((q) => q.url === url)) {\n          queue.push({\n            id: `textarea-${index}`,\n            url: url,\n            title: `Video ${queue.length + 1}`,\n            status: 'pending',\n          });\n        }\n      }\n    });\n  });\n\n  // Try to find any elements containing YouTube URLs\n  if (queue.length === 0) {\n    const allText = document.body.innerText;\n    const allMatches =\n      allText.match(/(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]+)/g) || [];\n    const uniqueIds = [...new Set(allMatches.map((m) => m.match(/([a-zA-Z0-9_-]+)$/)?.[1]))];\n    uniqueIds.forEach((videoId, index) => {\n      if (videoId) {\n        queue.push({\n          id: `body-${index}`,\n          url: `https://www.youtube.com/watch?v=${videoId}`,\n          title: `Video ${index + 1}`,\n          status: 'pending',\n        });\n      }\n    });\n  }\n\n  console.log('[AI Video Suite] Extracted queue from DOM:', queue.length, 'videos');\n  return queue;\n};\n\n// Handle sync directly when button is clicked\nconst handleSyncDirectly = () => {\n  console.log('[AI Video Suite] Handling sync directly (bypassing app check)...');\n\n  const queue = extractQueueFromDOM();\n\n  if (queue.length === 0) {\n    console.log('[AI Video Suite] No videos found in DOM, cannot sync');\n    // Show a message to the user\n    showNotification('No videos found to sync. Please add YouTube URLs first.', 'warning');\n    return false;\n  }\n\n  // Store in chrome.storage.local\n  chrome.storage.local.set(\n    {\n      videoQueue: queue,\n      reverseOrder: false,\n      segmentDuration: 45,\n      customAppDetected: true,\n      syncSource: 'directExtraction',\n      syncTimestamp: Date.now(),\n    },\n    () => {\n      console.log('[AI Video Suite] Queue synced directly:', queue.length, 'videos');\n      showNotification(`âœ“ Synced ${queue.length} videos to extension!`, 'success');\n\n      // Notify background script\n      chrome.runtime.sendMessage({\n        type: 'LOG',\n        message: `Queue synced directly: ${queue.length} videos`,\n        level: 'success',\n      });\n    }\n  );\n\n  return true;\n};\n\n// Show notification in the page\nconst showNotification = (message, type = 'info') => {\n  // Try to find an existing notification area or create one\n  let notifArea = document.querySelector('#extension-notification-area');\n  if (!notifArea) {\n    notifArea = document.createElement('div');\n    notifArea.id = 'extension-notification-area';\n    notifArea.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      z-index: 999999;\n      font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n    `;\n    document.body.appendChild(notifArea);\n  }\n\n  const notif = document.createElement('div');\n  const bgColors = {\n    success: 'linear-gradient(135deg, #10b981, #059669)',\n    warning: 'linear-gradient(135deg, #f59e0b, #d97706)',\n    error: 'linear-gradient(135deg, #ef4444, #dc2626)',\n    info: 'linear-gradient(135deg, #3b82f6, #2563eb)',\n  };\n  notif.style.cssText = `\n    background: ${bgColors[type] || bgColors.info};\n    color: white;\n    padding: 12px 20px;\n    border-radius: 8px;\n    margin-bottom: 10px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n    font-size: 14px;\n    font-weight: 500;\n    animation: slideIn 0.3s ease-out;\n  `;\n  notif.textContent = message;\n  notifArea.appendChild(notif);\n\n  setTimeout(() => {\n    notif.style.animation = 'slideOut 0.3s ease-in';\n    setTimeout(() => notif.remove(), 300);\n  }, 4000);\n};\n\n// Add CSS animation\nconst style = document.createElement('style');\nstyle.textContent = `\n  @keyframes slideIn {\n    from { transform: translateX(100%); opacity: 0; }\n    to { transform: translateX(0); opacity: 1; }\n  }\n  @keyframes slideOut {\n    from { transform: translateX(0); opacity: 1; }\n    to { transform: translateX(100%); opacity: 0; }\n  }\n`;\ndocument.head.appendChild(style);\n\n// Intercept clicks on \"Sync to Extension\" button\ndocument.addEventListener(\n  'click',\n  (e) => {\n    const target = e.target;\n    const buttonText = (target.textContent || '').toLowerCase();\n    const isButton = target.tagName === 'BUTTON' || target.closest('button');\n\n    if (isButton && buttonText.includes('sync') && buttonText.includes('extension')) {\n      console.log('[AI Video Suite] Intercepted Sync to Extension click!');\n\n      // Prevent the default app behavior which would show the error\n      e.preventDefault();\n      e.stopPropagation();\n      e.stopImmediatePropagation();\n\n      // Handle the sync ourselves\n      handleSyncDirectly();\n\n      return false;\n    }\n  },\n  true\n); // Use capture phase to intercept before the app\n\n// Listen for messages from the custom app (sent via window.postMessage)\nwindow.addEventListener('message', (event) => {\n  // Only process messages from the same window (the app's own postMessage)\n  if (event.source !== window) return;\n\n  console.log('[AI Video Suite] Iframe received message:', event.data?.type);\n\n  // Handle SYNC_TO_EXTENSION from the custom app\n  if (event.data?.type === 'SYNC_TO_EXTENSION') {\n    const { videoQueue, reverseOrder, segmentDuration } = event.data.data || {};\n\n    console.log('[AI Video Suite] Syncing queue from custom app:', {\n      videoCount: videoQueue?.length || 0,\n      reverseOrder,\n      segmentDuration,\n    });\n\n    // Store in chrome.storage.local\n    chrome.storage.local.set(\n      {\n        videoQueue: videoQueue || [],\n        reverseOrder: reverseOrder || false,\n        segmentDuration: segmentDuration || 45,\n        customAppDetected: true,\n        syncTimestamp: Date.now(),\n      },\n      () => {\n        console.log('[AI Video Suite] Queue synced to extension storage');\n\n        // Send confirmation back to the app\n        window.postMessage(\n          {\n            type: 'EXTENSION_SYNC_CONFIRMED',\n            success: true,\n            message: `Successfully synced ${videoQueue?.length || 0} videos to extension!`,\n          },\n          '*'\n        );\n\n        // Notify background script\n        chrome.runtime.sendMessage({\n          type: 'LOG',\n          message: `Queue synced from custom app: ${videoQueue?.length || 0} videos`,\n          level: 'success',\n        });\n\n        // Also send a status update that the popup can display\n        chrome.runtime.sendMessage({\n          type: 'STATUS_UPDATE',\n          message: `Queue ready: ${videoQueue?.length || 0} videos from AI Library`,\n        });\n      }\n    );\n\n    return;\n  }\n\n  // Handle START_AUTOMATION from the custom app\n  if (event.data?.type === 'START_AUTOMATION') {\n    console.log('[AI Video Suite] Automation start requested from custom app');\n\n    chrome.runtime.sendMessage({\n      type: 'START_AUTOMATION',\n      source: 'customApp',\n    });\n\n    return;\n  }\n\n  // Handle PAUSE_AUTOMATION from the custom app\n  if (event.data?.type === 'PAUSE_AUTOMATION') {\n    chrome.runtime.sendMessage({\n      type: 'PAUSE_AUTOMATION',\n    });\n    return;\n  }\n\n  // Handle STOP_AUTOMATION from the custom app\n  if (event.data?.type === 'STOP_AUTOMATION') {\n    chrome.runtime.sendMessage({\n      type: 'STOP_AUTOMATION',\n    });\n    return;\n  }\n});\n\n// Listen for messages FROM the extension (to send to the app)\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  console.log('[AI Video Suite] Iframe received message from extension:', message.type);\n\n  // Forward status updates to the custom app\n  if (\n    message.type === 'STATUS_UPDATE' ||\n    message.type === 'PROGRESS_UPDATE' ||\n    message.type === 'LOG' ||\n    message.type === 'AUTOMATION_COMPLETE' ||\n    message.type === 'AUTOMATION_ERROR'\n  ) {\n    window.postMessage(\n      {\n        type: 'FROM_EXTENSION',\n        originalType: message.type,\n        data: message,\n      },\n      '*'\n    );\n\n    sendResponse({ received: true });\n    return true;\n  }\n\n  return false;\n});\n\n// Inject a page script to set the extension flag and provide helper functions\n// ALWAYS inject this, not just for detected custom apps\n// NOTE: Uses postMessage instead of inline script to comply with CSP\nconst signalExtensionReady = () => {\n  // Send EXTENSION_READY message that the app can listen for\n  // This is CSP-compliant since we're using postMessage, not inline scripts\n  window.postMessage(\n    {\n      type: 'EXTENSION_READY',\n      connected: true,\n      extensionName: 'AI Video Intelligence Suite',\n      capabilities: ['sync', 'automation', 'status_updates'],\n    },\n    '*'\n  );\n\n  window.postMessage(\n    {\n      type: 'EXTENSION_BRIDGE_READY',\n      connected: true,\n    },\n    '*'\n  );\n\n  console.log('[AI Video Suite] Extension ready signal sent via postMessage');\n};\n\n// Respond to connection check requests\nwindow.addEventListener('message', (event) => {\n  if (event.source !== window) return;\n\n  if (event.data?.type === 'CHECK_EXTENSION_CONNECTION') {\n    window.postMessage(\n      {\n        type: 'EXTENSION_CONNECTION_STATUS',\n        connected: true,\n        extensionName: 'AI Video Intelligence Suite',\n      },\n      '*'\n    );\n  }\n});\n\n// ALWAYS signal extension ready - don't wait for custom app detection\nconsole.log(\n  '[AI Video Suite] Iframe Bridge: Signaling extension ready to',\n  window.location.hostname\n);\nsignalExtensionReady();\n\n// Signal again after a short delay to catch late-loading apps\nsetTimeout(signalExtensionReady, 500);\nsetTimeout(signalExtensionReady, 1500);\n\n// Also listen for the original app's sync attempts and relay them to window.top\ndocument.addEventListener(\n  'click',\n  (e) => {\n    const target = e.target;\n    const buttonText = target.textContent?.toLowerCase() || '';\n\n    // If user clicks a button with \"sync\" and \"extension\" in the text\n    if (buttonText.includes('sync') && buttonText.includes('extension')) {\n      console.log('[AI Video Suite] Sync button click detected, ensuring bridge is active');\n\n      // Signal extension ready again\n      signalExtensionReady();\n    }\n  },\n  true\n);\n\nconsole.log('[AI Video Suite] Iframe Bridge: Initialization complete on', window.location.hostname);\n"],"names":[],"ignoreList":[],"sourceRoot":""}